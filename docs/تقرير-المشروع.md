# تقرير المشروع — قيد العقار (Finance Flow)

ضع هنا تقرير كلاود عن المشروع. بعد حفظ المحتوى، يمكن للـ AI الاطلاع عليه لمعرفة ما تم إنجازه وما المتبقي.

---

## المحتوى (أضف نص التقرير أدناه)

I'll run multiple exploration agents in parallel to cover all six areas thoroughly.


Completed comprehensive codebase audits identifying error handling gaps, performance issues, security vulnerabilities, code duplication, input validation gaps, and accessibility problems
Show more
Show more
Show more
Show more
Show more
Show more
Show more

Codebase Audit Report — Finance Flow
Here's the full prioritized audit across all six areas. Findings are ranked P0 (fix now) through P3 (nice-to-have).

P0 — Critical (data loss, corruption, or security risk)
1. Backup/Restore Accepts Malicious or Corrupt Data
src/App.jsx:2970-3027

Only checks envelope.app, envelope.schema, and typeof envelope.data === 'object'
No validation of individual data arrays (transactions, ledgers, recurring items)
storageFacade.setRaw(k, String(d[k])) writes raw values — arrays become "[object Object]" if not already strings
No file size check — user can import a multi-GB file and freeze the browser
No rejection of __proto__, constructor, or prototype keys (partial prototype pollution vector)
No rollback — if restore fails midway, localStorage is left in an inconsistent state
2. localStorage Writes Have No Quota Handling
assets/js/core/storage.js:17-21, 32-36 and public/assets/js/core/storage.js:17-21, 32-36

setRaw() and setJSON() call localStorage.setItem() with zero try/catch
QuotaExceededError crashes the app; SecurityError in incognito silently fails
src/core/storage-facade.js:28-35 catches errors but returns false silently — no caller checks the return value
3. Runtime Contracts Defined but Not Used
src/core/contracts.js defines invariant, assertFn, assertObj, assertArr

Only imported in one place: src/App.jsx:2615-2618 (LedgerRecurringTab props guard)
Zero usage in any core/ module, any domain/ module, or any other tab component
Module boundaries are completely unguarded against undefined/null inputs
4. Brain Calculations Run Unmemorized Every Render
src/App.jsx:1977-1992

7 expensive pure-function calls (calculateBurnRateBundle, calculateCashPressureScore, calculateNext90DayRisk, calculateDisciplineTrend, detectHighRiskCluster, getDailyPlaybook, getBenchmarkComparison) wrapped in an IIFE — no useMemo
Each involves O(n) filters/reduces over all recurring items
Runs on every parent re-render, not just when activeId or recurring changes
5. Ledger Transactions Parsed From localStorage Inside Render Loop
src/App.jsx:2540-2606

Inside a .map() rendering ledger cards, calls dataStore.transactions.list() which does JSON.parse(localStorage.getItem(...)) per ledger
5 ledgers = 5 full JSON parses of the entire transaction array per render cycle
P1 — High (crashes, wrong calculations, or significant perf waste)
6. NaN Propagation From Number() Without Checks
Multiple locations convert user input with Number(form.amount) and save directly:

src/App.jsx:1212 — Transaction save: amount: Number(form.amount)
src/App.jsx:1474 — Commission save: dealValue: Number(form.dealValue), officePercent: Number(form.officePercent), agentPercent: Number(form.agentPercent)
src/App.jsx:3108 — Settings: defaultCommissionPercent: Number(e.target.value) — note: NaN || 50 evaluates to NaN, not 50
src/domain/recurringItems.js:26 — amount: Number(amount || 0) — Number("abc" || 0) = NaN
NaN stored in localStorage propagates into every calculation that touches the record.

7. No Tab Component Memoization
src/tabs/LedgerRecurringTab.jsx (930 lines) — not wrapped in React.memo, receives 60+ props
src/tabs/LedgerPerformanceTab.jsx (262 lines) — same
src/tabs/LedgerInboxTab.jsx, LedgerReportsTab.jsx, LedgerForecastTab.jsx — same
Every state change in App.jsx re-renders all visible tabs
8. IIFE Filtering Without useMemo
src/App.jsx:1964-1970

const ledgerTxs = (() => {
  const all = dataStore.transactions.list(); // JSON.parse on every render
  return filterTransactionsForLedgerByMeta({ transactions: all, ledgerId: activeId });
})();

Should be useMemo with [activeId] dependency.

9. refresh() Swallows Errors Silently
src/App.jsx:1822-1825

try { setLedgersState(getLedgers()); } catch { setLedgersState([]); }

If storage is corrupted, the user sees an empty app with no error message — indistinguishable from "no data."

10. Date Validation Missing on Forms
src/App.jsx:1204 — Transaction date: only checks !form.date, not if it's a valid date ("2025-99-99" passes)
src/App.jsx:2375-2376 — Recurring nextDueDate: same — only checks non-empty
src/domain/charts.js:6-8 — getMonthKey() creates new Date(dateStr) and returns "NaN-NaN" on invalid input
11. domain/transactions.js:11-14 — Crash on Missing Properties
if (f.fromDate) out = out.filter(t => t.date >= f.fromDate);

If any transaction lacks a .date property, undefined >= "2025-01-01" is false — the transaction silently disappears from results. Not a crash, but a silent data-loss bug.

12. Gold Accent Color Fails WCAG AA Contrast
assets/qaydalaqar-theme.css:38 — --qa-gold: #B8A76A on white gives ~3.4:1 ratio (minimum is 4.5:1 for AA text). Used on interactive elements.

P2 — Medium (code quality, duplication, UX gaps)
13. CRUD Pattern Duplicated 3x in dataStore
src/App.jsx:447-562 — transactions, commissions, and letters each repeat identical list/create/update/remove logic (~40 lines each). Should be a generic factory.

14. CSV Export Logic Duplicated
src/App.jsx:186-202 — csvEscape + downloadCSV defined
src/App.jsx:1066-1077 — Transaction CSV export
src/App.jsx:1301-1317 — Commission CSV export
src/tabs/LedgerReportsTab.jsx:51-67 — Ledger CSV export
All three exports repeat the same BOM + header + row join pattern.

15. Identical Files: assets/ vs public/assets/
assets/js/core/formatters.js and public/assets/js/core/formatters.js are 100% identical (82 lines). One should be deleted.

16. No Focus Trap in Modals
src/ui/Modals.jsx — Both Modal and ConfirmDialog have proper role="dialog" and Escape key support, but Tab key can escape the modal and focus elements behind the backdrop. (WCAG 2.4.3)

17. Tabs Missing ARIA Tablist Pattern
src/ui/ledger/LedgerHeader.jsx:11-14 — Tab buttons lack role="tablist", role="tab", aria-selected, and aria-controls. Content panels lack role="tabpanel". (WCAG 4.1.2)

18. Toast Notifications Lack aria-live
Toast messages appear/disappear with no live region announcement. Screen reader users never hear them. (WCAG 4.1.3)

19. ~131 Inline Event Handlers in App.jsx
Throughout the 4000-line file, patterns like onClick={() => setPeriodType(opt.v)} create new function instances every render. Combined with no React.memo on children, this cascades into significant unnecessary work.

20. Inline Array/Object Literals in JSX
src/App.jsx:973-977 — Period filter options array recreated every render:

{[ { v:'thisMonth', l:'هذا الشهر' }, ... ].map(opt => ( ... ))}

Should be a module-level constant.

21. Hardcoded Directional CSS (RTL)
src/ui/Sidebar.jsx:133 — text-left should be text-start
src/App.jsx:935, 1154-1158 — text-right on table headers should be text-start
src/App.jsx:1099, 1336 — pr-9 pl-3 on search inputs should be ps-9 pe-3
assets/mobile-responsive-fixes.css:647, 861 — right: 0 and border-right should use logical properties
22. No Maximum Length Validation on Text Inputs
Ledger name (src/App.jsx:1870), recurring title (src/App.jsx:2368), office name (src/App.jsx:3097) — all accept unlimited length. Long strings break UI layout and eat storage quota.
23. Hamburger Menu Missing aria-expanded
src/ui/Sidebar.jsx:130 — Has aria-label but no aria-expanded to indicate open/closed state. (WCAG 4.1.2)

P3 — Low (polish, best practices)
24. No Skip-to-Content Link
No "skip to main content" landmark link for keyboard users to bypass the sidebar. (WCAG 2.4.1)

25. Tables Missing <caption> and scope
src/App.jsx:1152-1159, 1384-1393 — Data tables lack <caption> and <th scope="col">. Screen readers can't announce table purpose. (WCAG 1.3.1)

26. Decorative Icons Not Hidden
src/App.jsx:861, 1135 — Empty state icons (<Icons.empty size={64}/>) should have aria-hidden="true". (WCAG 1.1.1)

27. Form Errors Lack aria-invalid
Form fields with validation errors don't set aria-invalid="true" or aria-describedby pointing to the error message. (WCAG 3.3.1)

28. ledger-budgets.js:3-6 — Silent Zero Conversion
const asNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : 0; };

"abc" silently becomes 0 — indistinguishable from an actual zero budget. No feedback to the user.

29. useMemo Wrong Dependency
src/App.jsx:964-967

const chartData = useMemo(() => {
  const allTxs = dataStore.transactions.list({});
  return buildLast6MonthsIncomeExpenseChart(allTxs);
}, [txs]);

Memoizes on txs but internally fetches all transactions via dataStore.transactions.list({}). Dependency doesn't match the data source.

Summary Table
Priority	Category	Count
P0	Critical	5
P1	High	7
P2	Medium	11
P3	Low	6
Total	29
The biggest wins come from three areas:

Backup/restore validation (P0 #1) — highest security risk
Memoization (P0 #4-5, P1 #7-8) — biggest perf improvement for least code change
Input validation with NaN guards (P1 #6) — prevents silent data corruption
Want me to start fixing any of these?