# سجل التغييرات — Finance Flow

## v0.4.2 – Phase 4.1.6 Input Focus Bug Fix (Critical)

- **الخلل**: عند الكتابة في حقول نماذج الحركات المالية أو العمولات (مثل المبلغ، الوصف، اسم العميل)، كان المؤشر يفقد التركيز (blur) بعد حرف أو رقم واحد.
- **السبب الجذري**: المكوّن المساعد `Field` كان معرّفًا **داخل** المكوّن الأب (`TransactionForm` و`CommissionForm`). في كل إعادة render (مثلاً عند كل onChange) يتم إنشاء دالة `Field` جديدة، فيتعامل React معها كمكوّن جديد فيقوم بإلغاء mount المكوّن القديم وعمل mount للمكوّن الجديد، فيُعاد إنشاء عناصر الـ input فتُفقد التركيز.
- **الإصلاح**: نقل تعريف المكوّن المساعد إلى مستوى الملف (خارج المكوّن الأب) وتسميته `FormField` حتى يكون مرجع الدالة ثابتًا ولا يُعاد إنشاؤه عند كل render. سلوك التحقق وعرض الأخطاء بقي كما هو.
- الملفات المُعدّلة: `finance-flow.html` فقط. لا تغيير في البيانات أو المنطق أو الواجهة.

## v0.4.3 – Phase 4.1.7 Letters Templates Content

- **توحيد قوالب الخطابات**: أصبح لكل قالب «نص خطاب كامل» (Body) مثل قالب «خطاب مخاطبة جهة»:
  - **خطاب تعريف بالمكتب**: إضافة حقل «نص الخطاب» مع نص افتراضي كامل (تعريف بالمكتب وخدماته)، وعرضه في المعاينة والطباعة.
  - **خطاب مخاطبة جهة**: بدون تغيير (كان يحتوي بالفعل على نص خطاب كامل).
  - **خطاب تفويض**: إضافة حقل «نص الخطاب» مع نص افتراضي كامل (تفويض مندوب وسريان المفعول)، وعرضه في المعاينة والطباعة.
- **بدون تغيير منطق الحقول أو الطباعة**: الحقول الأخرى (اسم المستلم، الجهة، المفوّض، الغرض، إلخ) والتحقق والحفظ والطباعة كما هي؛ التعديل على اكتمال النصوص/المحتوى فقط.
- الملف المُعدّل: `finance-flow.html`. توثيق في `docs/CHANGELOG.md`.

### v0.4.3 – Fix delegation letter binding

- **الخلل**: في قالب «خطاب تفويض»، حقول اسم المفوّض، رقم الهوية، الغرض من التفويض، ونص الخطاب عند الكتابة لا تنعكس في المعاينة/نص الخطاب؛ فقط اسم المدير كان ينعكس.
- **السبب الجذري**: بعد Phase 4.1.7 تم جعل معاينة التفويض تعرض حقل `body` فقط، دون استخدام قيم الحقول `delegateName` و`delegateId` و`purpose` في الـ renderer، فانقطع الربط بين الـ inputs ونص الخطاب.
- **الإصلاح**: في `renderPreview` لقالب التفويض، بناء فقرة النص من الحقول `officeName`، `delegateName`، `delegateId`، `purpose` لعرضها في المعاينة، مع الإبقاء على عرض `body` إن وُجد كنص إضافي؛ نفس مصدر البيانات `fields` المستخدم في الـ inputs.
- الملف المُعدّل: `finance-flow.html` فقط. لا تغيير في واجهة المستخدم أو الـ schema أو إضافة حقول.

## v0.4.4 – Drafts UI parity with templates

- واجهة قسم «المسودات» أصبحت تطابق تصميم «قوالب الخطابات»: نفس الـ grid (sm:grid-cols-3)، نفس شكل البطاقة (rounded-xl، p-6، shadow، hover)، نفس الأيقونة والترتيب (عنوان، وصف ثانوي، تاريخ بالعربية، زر CTA بعرض كامل). زر «فتح المسودة» يفتح المسودة كما كان؛ زر الحذف كأيقونة صغيرة في زاوية البطاقة.
- الملفات المُعدّلة: `finance-flow.html`، `docs/CHANGELOG.md`.

## v0.4.5 – Sidebar Home nav fix

- زر «الرئيسية» في القائمة الجانبية كان يغيّر الصفحة إلى `home` (صفحة البطاقات الأربع)؛ المطلوب أن ينقّل إلى لوحة المعلومات (dashboard). تم جعل `handleNav('home')` يستدعي `setPage('dashboard')` مع إبراز الزر عند كون الصفحة الحالية dashboard، وإضافة `type="button"` لأزرار القائمة لتفادي أي سلوك افتراضي.
- الملفات المُعدّلة: `finance-flow.html`، `docs/CHANGELOG.md`.

## v0.4.6 – Sidebar de-dup Home/Dashboard active fix

- عند page='dashboard' كان يظهر «الرئيسية» و«لوحة المعلومات» مميزين معًا. تم حذف عنصر «لوحة المعلومات» من القائمة؛ بقي «الرئيسية» (id:'home') فقط كمدخل للوحة، وhandleNav('home') يستدعي setPage('dashboard')، وعنصر «الرئيسية» يظهر Active عندما page==='dashboard' فقط.
- الملفات المُعدّلة: `finance-flow.html`، `docs/CHANGELOG.md`.

## v0.4.7 – Sidebar reorder (Home first)

- إعادة ترتيب عرض القائمة الجانبية فقط: الرئيسية أولاً، ثم التدفقات المالية (الحركات المالية، العمولات)، ثم الخطابات (قوالب الخطابات، إنشاء خطاب، المسودات)، ثم الإعدادات. لم يُغيّر أي id أو setPage أو handleNav أو منطق Active.
- الملفات المُعدّلة: `finance-flow.html`، `docs/CHANGELOG.md`.

## v0.4.8 – Commissions toolbar parity (search/filters/date/CSV/print)

- إضافة شريط أدوات في صفحة العمولات مطابق لصفحة الحركات المالية: بحث (العميل/الصفقة واسم الوكيل)، فلتر الحالة (كل الحالات/معلقة/مدفوعة)، فلتر الوكيل (قائمة الوكلاء)، فلتر الفترة (من–إلى بناءً على dueDate أو paidDate)، زر إعادة تعيين الفلاتر، أزرار إضافة عمولة وCSV وطباعة. تصدير CSV مع BOM وcsvEscape؛ حالة فارغة عند تطابق الفلاتر مع زر «إعادة تعيين الفلاتر».
- الملفات المُعدّلة: `finance-flow.html`، `docs/CHANGELOG.md`.

---
