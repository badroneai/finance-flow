# تقرير شامل عن المشروع — قيد العقار (Finance Flow)

**تاريخ التقرير:** مراجعة الحالة الحالية دون تعديل أي كود.  
**النطاق:** تحليل وتوثيق فقط.

---

## 1. نظرة عامة

### اسم المشروع والهدف الرئيسي
- **الاسم:** قيد العقار (Finance Flow) — النسخة العامة (finance-flow-public).
- **الهدف:** أداة ويب لإدارة التدفقات المالية والعمولات والخطابات للمكاتب العقارية، تعمل **بالكامل على المتصفح (Static)** بدون خادم خلفي، مع تخزين البيانات في **localStorage** على جهاز المستخدم. مناسبة للنشر على GitHub Pages أو أي استضافة ثابتة.

### التقنيات المستخدمة
| المجال | التقنية |
|--------|----------|
| **Framework** | React 19.x |
| **أداة البناء** | Vite 7.x مع @vitejs/plugin-react |
| **قاعدة البيانات** | لا يوجد خادم — التخزين المحلي فقط: **localStorage** عبر طبقة `storage` و `storageFacade` |
| **المصادقة (Auth)** | لا يوجد — التطبيق محلي بالكامل، لا حسابات ولا تسجيل دخول |
| **الاستضافة** | مُعد للنشر الثابت (مثل GitHub Pages)، `base: './'` في vite.config |
| **التنسيق والخط** | Tailwind CSS (عبر CDN في finance-flow.html)، خط IBM Plex Sans Arabic، ثيم مخصص في `qaydalaqar-theme.css` |
| **لغة الكود** | JavaScript فقط — **لا يوجد TypeScript** (جميع الملفات .js / .jsx) |

### هيكل المجلدات الرئيسي (مبسّط)

```
finance-flow-2/
├── finance-flow.html      # نقطة الدخول الوحيدة للتطبيق (Vite input)
├── index.html             # صفحة هبوط/ترحيب (إن وُجدت)
├── landing.html           # صفحة هبوط منفصلة (في الجذر أو public)
├── package.json
├── vite.config.js
├── src/
│   ├── main.jsx           # نقطة تركيب React + Error Boundary
│   ├── App.jsx            # التطبيق الرئيسي (~4000 سطر): التوجيه، الصفحات، dataStore، النماذج
│   ├── core/              # تخزين، عقود، تقارير دفتر، ميزانيات، ذكاء التكرار
│   │   ├── storage-facade.js
│   │   ├── ledger-store.js
│   │   ├── ledger-reports.js
│   │   ├── ledger-budgets.js
│   │   ├── contracts.js
│   │   ├── recurring-intelligence.js
│   │   └── ...
│   ├── domain/            # منطق نقي: حركات، عمولات، دفاتر، تقويم، خطابات، رسوم بيانية
│   │   ├── transactions.js
│   │   ├── charts.js
│   │   ├── ledgers.js
│   │   ├── recurringItems.js
│   │   └── index.js (re-exports)
│   ├── ui/                # مكونات واجهة مشتركة
│   │   ├── Sidebar.jsx     # القائمة الجانبية + Topbar
│   │   ├── Modals.jsx      # Modal، ConfirmDialog
│   │   └── ledger/         # LedgerHeader، LedgerTabsShell
│   ├── tabs/              # تبويبات صفحة الدفاتر
│   │   ├── LedgerRecurringTab.jsx
│   │   ├── LedgerReportsTab.jsx
│   │   ├── LedgerPerformanceTab.jsx
│   │   ├── LedgerInboxTab.jsx
│   │   └── LedgerForecastTab.jsx
│   └── utils/
│       └── csvExport.js
├── assets/                # ثيم، CSS، سكربتات قديمة (مفاتيح، تخزين)
│   ├── js/core/           # keys.js, storage.js
│   ├── qaydalaqar-theme.css
│   ├── mobile-responsive-fixes.css
│   └── css/
├── public/                # أصول ثابتة تُنسخ كما هي
│   └── assets/            # نسخة من ثيم وسكربتات (formatters.js مشترك بعد P2#15)
├── docs/
│   ├── تقرير-المشروع.md   # تقرير التدقيق الأصلي (P0–P3)
│   ├── P0-FIXES-LOG.md    # سجل تنفيذ الإصلاحات
│   └── تقرير-شامل-المشروع.md (هذا الملف)
└── dist/                  # مخرجات `npm run build`
```

---

## 2. الصفحات والمكونات

### قائمة الصفحات (Routes)

التوجيه داخلي عبر state في `App.jsx` (`page` + `setPage`) وليس React Router. القيمة الافتراضية `'home'`، والـ switch على `page`:

| القيمة (Route) | الصفحة | الوصف المختصر |
|----------------|--------|-----------------|
| `home` | HomePage | الصفحة الرئيسية: بطاقات اختصار للوحة التحكم، الحركات، العمولات، الدفاتر، القوالب، المسودات، التقويم، الملاحظات، الإعدادات. |
| `dashboard` | DashboardPage | لوحة تحليل الأداء المالي: فلاتر فترة (هذا الشهر، آخر 3/6 أشهر، مخصص)، بطاقات إجمالي الدخل/الخرج/الصافي، رسم بياني لآخر 6 أشهر، قائمة عمولات معلقة. |
| `transactions` | TransactionsPage | سجل الحركات المالية: جدول مع فلاتر (نوع، تصنيف، طريقة دفع، تاريخ)، إضافة/تعديل/حذف، تصدير CSV، طباعة. |
| `commissions` | CommissionsPage | العمولات: جدول عمولات مع فلاتر (حالة، وكيل، تاريخ)، إضافة/تعديل/حذف، تسجيل الدفع، تصدير CSV. |
| `ledgers` | LedgersPage | الدفاتر: إنشاء/تعديل دفاتر، تبويبات فرعية (دفاتر، التزامات متكررة، تقارير الدفتر، أداء الدفتر)، ميزانيات، نماذج التكرار، تحويل التكرار إلى حركة. |
| `templates` | TemplatesPage | قوالب الخطابات: بطاقات لاختيار نوع الخطاب (تعريف، مخاطبة، تفويض). |
| `generator` | GeneratorPage | إنشاء خطاب: نموذج حقول حسب القالب، معاينة، حفظ مسودة، طباعة. |
| `drafts` | DraftsPage | المسودات: قائمة مسودات الخطابات مع تعديل/حذف/استئناف التحرير. |
| `calendar` | NotesCalendar (mode=calendar) | عرض التقويم مع أحداث وملاحظات يومية. |
| `notes` | NotesCalendar (mode=notes) | عرض الملاحظات والتثبيت. |
| `settings` | SettingsPage | الإعدادات: اسم المكتب، هاتف، بريد، نسبة العمولة الافتراضية، مظهر (ثيم)، نمط الأرقام، رأس التاريخ، استيراد/تصدير نسخة احتياطية، مسح البيانات. |

لا يوجد مسار URL يقابل كل صفحة (لا React Router) — التطبيق Single Page يعتمد على state فقط.

### المكونات المشتركة (Shared Components)

- **Sidebar / Topbar** (`src/ui/Sidebar.jsx`): القائمة الجانبية (مجموعات: تدفقات مالية، خطابات، ملاحظات وتقويم)، طي/توسيع، قائمة هامبرجر للموبايل، شريط علوي بعنوان الصفحة وتاريخ.
- **Modal / ConfirmDialog** (`src/ui/Modals.jsx`): نوافذ منبثقة مع focus trap وزر إغلاق و Escape.
- **LedgerHeader / LedgerTabsShell** (`src/ui/ledger/`): رأس تبويبات الدفاتر (تبويبات: دفاتر، التزامات متكررة، تقارير، أداء) وقشرة المحتوى.
- **FormField / SettingsField** (معرّفة في `App.jsx`): حقل نموذج مع تسمية وخطأ وربط aria.
- **SummaryCard, Currency, Badge, EmptyState, EnhancedEmptyState** (في `App.jsx`): بطاقات ملخص، تنسيق عملة، شارة، وحالات فارغة.
- **ToastProvider / useToast**: إشعارات Toast مع region و aria-live.
- **RootErrorBoundary / LedgerTabErrorBoundary**: حدود أخطاء لتجنب الصفحة البيضاء.

### نظام التنقل (Navigation)

- **Sidebar:** عناصر تنقل ثابتة (`NAV_ITEMS`) مع `setPage(id)`؛ عنصر "دليل سريع" يفتح لوحة المساعدة بدل تغيير الصفحة.
- **HomePage:** بطاقات اختصار تستدعي `setPage(item.id)` (مثل dashboard، transactions، …).
- **لا يوجد شريط عناوين (URL) للصفحات** — التنقل كله داخل التطبيق عبر state.

---

## 3. قاعدة البيانات

المشروع **لا يستخدم خادم قاعدة بيانات**. التخزين بالكامل في **localStorage** عبر مفاتيح موحدة.

### هيكل المفاتيح والبيانات (مثل جداول/Collections)

| المفتاح (Key) | الوصف | الشكل العام للقيمة |
|---------------|--------|---------------------|
| `ff_transactions` | الحركات المالية | مصفوفة عناصر: `id`, `type`, `category`, `amount`, `paymentMethod`, `date`, `description`, `ledgerId`, `createdAt`, `updatedAt`. قد تحتوي عناصر على `meta` (ledgerId، recurringId). |
| `ff_commissions` | العمولات | مصفوفة: `id`, `clientName`, `dealValue`, `officePercent`, `agentPercent`, `status` (pending/paid), `dueDate`, `paidDate`, `createdAt`, `updatedAt`. |
| `ff_drafts` | مسودات الخطابات | مصفوفة: `id`, `templateType`, `fields` (كائن حقول)، `createdAt`, `updatedAt`. |
| `ff_settings` | إعدادات التطبيق | كائن واحد: `officeName`, `phone`, `email`, `defaultCommissionPercent`, `theme`, `numerals`, إلخ. |
| `ff_seeded` | هل تم تهيئة البيانات التجريبية | boolean. |
| `ff_ledgers` | قائمة الدفاتر | مصفوفة: كل عنصر `id`, `name`, `type`, `note`, `currency`, `budgets` (اختياري)، `incomeModel` (اختياري)، `createdAt`, `updatedAt`, `archived`. |
| `ff_recurring_items` | بنود الالتزامات المتكررة | مصفوفة: `id`, `ledgerId`, `title`, `category`, `amount`, `frequency`, `nextDueDate`, `notes`, `createdAt`, `updatedAt`، وحقول حالة دفع اختيارية. |
| `ff_active_ledger_id` | الدفتر النشط الحالي | سلسلة (id الدفتر). |
| `ui_theme`, `ui_numerals`, `ui_date_header`, `ui_onboarding_seen`, `hasSeenWelcomeBanner` | إعدادات واجهة | قيم نصية أو boolean حسب المفتاح. |

### العلاقات بين الجداول

- **الحركات → دفتر:** حقل `ledgerId` (وبعضها قد يحمله في `meta.ledgerId` بعد هجرة).
- **الالتزامات المتكررة → دفتر:** `ledgerId` يربط البند بالدفتر.
- **المسودات:** مستقلة، لا ربط رسمي بجدول آخر.
- **العمولات:** مستقلة عن الدفاتر في التصميم الحالي.

لا توجد foreign keys أو قيود على مستوى التخزين — العلاقات منطقية فقط في الكود.

### قواعد الأمان (Security Rules)

- **لا يوجد خادم:** لا توجد قواعد أمان على مستوى قاعدة بيانات.
- **الوصول للبيانات:** أي سكربت يعمل في نفس الأصل (نفس النطاق) يمكنه قراءة/كتابة localStorage؛ الحماية تعتمد على عدم وجود سكربتات ضارة في الصفحة وعلى سياسة الاستضافة (مثلاً GitHub Pages لا تنفذ كود خادم).
- **النسخ الاحتياطي والاستعادة:** تم تقييد المفاتيح المقبولة وحجم الملف واستبعاد مفاتيح خطيرة (مثل __proto__) وتراجع عند الفشل (موثق في P0-FIXES-LOG).

---

## 4. الحالة الحالية

### الميزات المكتملة والتي تعمل بشكل صحيح

- الصفحة الرئيسية والتنقل بين كل الصفحات المذكورة أعلاه.
- سجل الحركات المالية: إضافة، تعديل، حذف، فلاتر، تصدير CSV، طباعة.
- العمولات: إضافة، تعديل، حذف، تسجيل الدفع، فلاتر، تصدير CSV.
- الدفاتر: إنشاء/تعديل دفاتر، التزامات متكررة، تقارير الدفتر (صافي 30/365، التزام، ميزانية، توزيع فئات)، أداء الدفتر، صندوق الوارد، التوقعات.
- قوالب الخطابات وإنشاء خطاب ومسودات.
- التقويم والملاحظات اليومية والتثبيت.
- الإعدادات: بيانات المكتب، ثيم، أرقام عربية/إنجليزية، رأس التاريخ، استيراد/تصدير نسخة احتياطية، مسح البيانات.
- التحقق من صحة المدخلات (تواريخ، مبالغ، أطوال حقول)، معالجة Quota، رسائل Toast عند الفشل، Error Boundaries، تحسينات إمكانية الوصول (ARIA، تخطي المحتوى، جداول، نماذج).
- البناء: `npm run build` ينتج `dist/` من `finance-flow.html` بنجاح.

### الميزات الناقصة أو قيد التطوير

- **لا يوجد اختبار آلي:** لا unit tests ولا integration tests (`"test": "echo \"(no tests yet)\""`).
- **رسم لوحة التحكم (chartData):** يعتمد على `useMemo(..., [])` — أي أن الرسم لا يتحدث تلقائياً عند إضافة حركات جديدة دون إعادة تحميل الصفحة أو تغيير الصفحة (مقبول كتنفيذ حالي، لكنه سلوك محدود).
- **لا مزامنة سحابية ولا نسخ احتياطي تلقائي** — الاعتماد الكامل على المستخدم (تصدير يدوي).

### المشاكل المعروفة (Known Issues / Bugs)

- معظم بنود تقرير التدقيق (P0–P3) **تم تنفيذ إصلاحاتها** وموثقة في `docs/P0-FIXES-LOG.md`. لا توجد قائمة منفصلة "مشاكل مفتوحة" في المستودع.
- **Placeholder في HTML:** في `finance-flow.html` يظهر `YOUR-USERNAME.github.io` في canonical و og — يجب استبداله قبل النشر الفعلي.
- في **وضع التصفح الخاص** قد يفشل localStorage أو يُمسح عند إغلاق المتصفح — التطبيق يكتشف ويحذر المستخدم (TrustChecks).
- **لا توجد معالجة صريحة لانقطاع الشبكة** (التطبيق لا يعتمد على شبكة للعمل الأساسي، لكن تحميل الخطوط أو CDN قد يتأثر).

---

## 5. جودة الكود

### TypeScript

- **لا يوجد TypeScript.** المشروع بالكامل JavaScript (`.js`, `.jsx`). لا توجد TypeScript errors أو warnings.

### Console

- **console.error** مستخدم في: `main.jsx` (RootErrorBoundary، فشل mount)، `App.jsx` (LedgerTabErrorBoundary) — مقصود لتسجيل الأخطاء.
- **console.warn** في `contracts.js` عند كسر عقد في بيئة غير تطويرية.
- لا يوجد سياسة موحدة لإزالة أو استبدال console في الإنتاج (لا تحويل تلقائي إلى خدمة تسجيل أخطاء).

### كود مكرر / غير مستخدم (Dead code)

- **تكرار تم تقليله:** تم توحيد CRUD (createCrud)، تصدير CSV (csvExport.js)، وإزالة نسخة مكررة من formatters (P2). يبقى قدر من التكرار في النماذج الكبيرة داخل App.jsx.
- **ملفات قديمة/بديلة:** وجود كل من `assets/` و `public/assets/` مع إعادة استخدام مصدر واحد لـ formatters بعد P2#15؛ `assets/js/bootstrap.js` يعيد التصدير من `public/assets/...` — قد يسبب التباساً للمطورين.
- **لا توجد تقارير dead code من أداة آلية** (مثل coverage أو eslint unused) في الوثائق.

### أداء

- تم تطبيق useMemo لـ ledgerTxs و Brain و chartData، وReact.memo لتبويبات الدفاتر، وعدم استدعاء `transactions.list()` داخل حلقة map (موثق في P0/P1).  
- **App.jsx كبير جداً (~4000+ سطر)** — أي تغيير في state قد يسبب إعادة عرض واسعة؛ التبويبات المُعلّقة بـ memo تخفف جزءاً من ذلك.  
- لا توجد قياسات أداء (مثل LCP أو CLS) موثقة في المستودع.

---

## 6. الأمان

### المتغيرات الحساسة (API Keys, Secrets)

- **لا توجد API keys أو أسرار في الكود** — التطبيق لا يتصل بخدمات خارجية تتطلب مصادقة (لا backend، لا قاعدة بيانات سحابية).
- الخطوط و Tailwind تُحمّل من CDN عامة (Google Fonts، cdn.tailwindcss.com) — لا بيانات مستخدم فيها.

### Environment variables

- **لا يوجد ملف `.env`** في المستودع (بحث بـ `process.env` / `import.meta.env` أظهر فقط استخدام `import.meta.env.DEV` في `contracts.js` لتمييز بيئة التطوير).  
- لا توجد متغيرات بيئة للإنتاج (مثل عنوان API أو مفتاح) — لا حاجة لها في النسخة الثابتة الحالية.

### ثغرات أمنية واضحة

- **البيانات في المتصفح فقط:** أي شخص يصل إلى الجهاز أو المتصفح يمكنه رؤية/تعديل localStorage.
- **استيراد النسخة الاحتياطية:** تم تقييد حجم الملف والمفاتيح المقبولة وكتابة آمنة وتراجع عند الفشل (P0#1) — يقلل مخاطر الاستيراد الخبيث أو التالف.
- **XSS:** المدخلات تُعرض في React (تهريب افتراضي)؛ لا يوجد تعقيم HTML يدوي موثق في التقرير. إدخال HTML في حقول نصية قد يكون خطيراً إذا وُجد مكان يُعرض فيه `dangerouslySetInnerHTML` — لم يُتحقق من كل المسارات.

---

## 7. تجربة المستخدم

### RTL والعربية

- **مدعومة:** `html` بـ `lang="ar"` و `dir="rtl"`، وخط IBM Plex Sans Arabic، ونصوص الواجهة بالعربية.  
- استخدام خصائص CSS المنطقية (مثل `text-start`, `text-end`, `inset-inline-end`) في أجزاء من التطبيق (بعد P2#21).  
- عرض الأرقام يمكن أن يكون عربي أو إنجليزي حسب إعداد `numerals` في الإعدادات.

### التصميم المتجاوب (Responsive)

- **مدعوم:** استخدام Tailwind (شبكات، breakpoints)، وملف `assets/mobile-responsive-fixes.css` لتحسينات الموبايل، وقائمة هامبرجر في الشريط العلوي للموبايل، وتبويبات قابلة للطي في الجداول/الفلاتر.  
- لا يوجد تقرير اختبار منهجي على أجهزة محددة.

### حالات التحميل والأخطاء

- **تحميل أولي:** وجود `#root-fallback` بنص "جاري تحميل التطبيق…" حتى يتم استبداله بـ React.  
- **أخطاء عامة:** RootErrorBoundary في main.jsx يعرض رسالة خطأ وزر "إعادة تحميل الصفحة" مع عرض رسالة الخطأ.  
- **أخطاء تبويب التقارير:** LedgerTabErrorBoundary يمنع الصفحة البيضاء ويعرض بديلاً مع إمكانية الرجوع.  
- **فشل التخزين:** Toast برسالة مناسبة عند فشل الحفظ (مثل Quota)، وتحذير عند اكتشاف التصفح الخاص أو امتلاء التخزين (TrustChecks).  
- **نماذج:** رسائل تحقق وحقول مرتبطة بـ aria-invalid و aria-describedby حيث طُبّق FormField مع id.

---

## 8. الجاهزية للإنتاج

### ما المتبقي لإطلاق المشروع؟

- **استبدال placeholders:** في `finance-flow.html` استبدال `YOUR-USERNAME.github.io` بعنوان الموقع الفعلي وقيم og/twitter إن لزم.
- **اختبار يدوي:** تشغيل سيناريوهات أساسية (إضافة حركات، عمولات، دفاتر، استيراد/تصدير، إعدادات) على متصفحات مستهدفة.
- **عدم وجود اختبارات آلية** — أي تغيير لاحق يعتمد على مراجعة يدوية أو إضافة tests لاحقاً.

### التبعيات (dependencies)

- **الإنتاج:** `react`, `react-dom` (^19.2.4).  
- **التطوير:** `vite` (^7.3.1), `@vitejs/plugin-react` (^5.1.4).  
- **npm audit:** عند تنفيذ `npm audit` كانت النتيجة **0 vulnerabilities**.  
- **تحذير npm:** يظهر "Unknown env config devdir" — تحذير من إعداد npm وليس من تبعيات المشروع نفسه.

---

*تم إعداد هذا التقرير بناءً على قراءة الكود والملفات والوثائق دون تنفيذ أي تعديلات على الكود.*
